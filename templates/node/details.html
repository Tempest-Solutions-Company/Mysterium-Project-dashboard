{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ node.name }}</h1>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
    
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Node Information</h5>
                <button id="refreshBtn" class="btn btn-sm btn-light">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Connection Details</h6>
                    <p><strong>IP:</strong> {{ node.ip }}</p>
                    <p><strong>Port:</strong> {{ node.port }}</p>
                    <!-- Add Statistics Button -->
                    <button id="viewStatsBtn" class="btn btn-sm btn-primary">
                        <i class="fas fa-chart-bar me-1"></i> View Statistics Charts
                    </button>
                </div>
                <div class="col-md-6" id="healthInfo">
                    <h6>Health Status</h6>
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading health information...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 d-flex align-items-center">
                            Session Statistics
                            <span class="ms-2" data-bs-toggle="tooltip" data-bs-placement="top" 
                                title="Sessions with status 'NEW' are currently open (live) sessions">
                                <i class="fas fa-info-circle text-primary" style="color: #8adfff !important;"></i>
                            </span>
                        </h5>
                    </div>
                </div>
                <div class="card-body" id="sessionStats">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading session statistics...</p>
                </div>
            </div>
            
            <!-- New Active Sessions Card -->
            <div class="card mb-4" id="activeSessionsCard">
                <div class="card-header bg-warning text-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 d-flex align-items-center">
                            <i class="fas fa-plug me-2"></i> Active Sessions
                            <span id="activeSessionsCount" class="badge bg-danger ms-2">0</span>
                        </h5>
                        <button id="refreshActiveBtn" class="btn btn-sm btn-dark">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body" id="activeSessionsStats">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading active sessions...</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Identities</h5>
                </div>
                <div class="card-body" id="identitiesList">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading identities...</p>
                </div>
            </div>
            
            <!-- New Node Quality Stats Card -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Node Quality Stats</h5>
                </div>
                <div class="card-body" id="nodeQualityStats">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading node quality statistics...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header bg-warning">
            <h5 class="mb-0">Services</h5>
        </div>
        <div class="card-body" id="servicesList">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading services...</p>
        </div>
    </div>
</div>

<!-- Add Statistics Modal -->
<div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="statsModalLabel">Session Statistics Charts</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="btn-group" role="group" aria-label="Chart period selection">
                        <button type="button" class="btn btn-outline-primary chart-period active" data-days="7">7 Days</button>
                        <button type="button" class="btn btn-outline-primary chart-period" data-days="14">14 Days</button>
                        <button type="button" class="btn btn-outline-primary chart-period" data-days="30">30 Days</button>
                    </div>
                </div>
                
                <div id="chartLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading charts...</span>
                    </div>
                    <p class="mt-2">Loading session statistics...</p>
                </div>
                
                <!-- Add custom CSS to increase chart container height -->
                <style>
                    .chart-container {
                        height: 300px;
                        position: relative;
                    }
                    @media (min-width: 992px) {
                        .chart-container {
                            height: 350px;
                        }
                    }
                    #chartContainer .card {
                        height: 100%;
                    }
                    #chartContainer .card-body {
                        display: flex;
                        flex-direction: column;
                    }
                </style>
                
                <div id="chartContainer" class="row" style="display: none;">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">Sessions Per Day</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="sessionsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">Earnings Per Day (MYST)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="earningsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">Data Transfer Per Day</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="dataTransferChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">Connection Duration Per Day</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="durationChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="noDataMessage" class="alert alert-info text-center" style="display: none;">
                    <i class="fas fa-info-circle me-2"></i>
                    No session data available for the selected period.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    const nodeId = "{{ node.id }}";
    const nodeIp = "{{ node.ip }}"; // Add this line to make node IP available to JavaScript
    
    // Add this variable to track services we've seen
    let knownServices = [];
    
    // Load persisted services from localStorage on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, initializing node dashboard");
        const storedServices = localStorage.getItem(`node_${nodeId}_services`);
        if (storedServices) {
            knownServices = JSON.parse(storedServices);
            console.log("Loaded saved services from localStorage:", knownServices);
        }
        
        // Safely initialize Bootstrap tooltips if Bootstrap is available
        try {
            if (typeof bootstrap !== 'undefined') {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
                console.log("Bootstrap tooltips initialized");
            } else {
                console.warn("Bootstrap not available, tooltips not initialized");
            }
        } catch (e) {
            console.error("Error initializing tooltips:", e);
        }
        
        // Add event listener for the Statistics Charts button
        document.getElementById('viewStatsBtn').addEventListener('click', function() {
            console.log("Opening statistics modal");
            // Create and show the bootstrap modal
            try {
                if (typeof bootstrap !== 'undefined') {
                    const statsModal = new bootstrap.Modal(document.getElementById('statsModal'));
                    statsModal.show();
                    
                    // Load chart data when modal is shown
                    loadChartData(7); // Default to 7 days
                } else {
                    console.error("Bootstrap is not available, cannot show modal");
                    alert("Unable to open statistics modal: Bootstrap not loaded");
                }
            } catch (e) {
                console.error("Error opening statistics modal:", e);
            }
        });
        
        // Add event listeners for chart period buttons
        document.querySelectorAll('.chart-period').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all period buttons
                document.querySelectorAll('.chart-period').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Get selected period in days
                const days = parseInt(this.getAttribute('data-days'), 10);
                
                // Load chart data for the selected period
                loadChartData(days);
            });
        });
        
        // Initialize refresh button event listener
        document.getElementById('refreshBtn').addEventListener('click', loadNodeData);
        document.getElementById('refreshActiveBtn').addEventListener('click', fetchConnectionStats);
        
        // Load initial node data
        loadNodeData();
    });
    
    // Function to load chart data and render charts
    function loadChartData(days) {
        // Show loading indicator
        document.getElementById('chartLoading').style.display = 'block';
        document.getElementById('chartContainer').style.display = 'none';
        document.getElementById('noDataMessage').style.display = 'none';
        
        console.log(`Loading chart data for last ${days} days`);
        
        // Use existing session data from the window.nodeData
        if (window.nodeData && window.nodeData.sessions && window.nodeData.sessions.items) {
            const sessions = window.nodeData.sessions.items;
            console.log(`Total sessions available: ${sessions.length}`);
            
            // Filter sessions within the selected period
            const now = new Date();
            const startDate = new Date();
            startDate.setDate(now.getDate() - days);
            
            console.log(`Filtering sessions from ${startDate.toISOString()} to ${now.toISOString()}`);
            
            // Group sessions by day
            const sessionsByDay = {};
            const earningsByDay = {};
            const dataTransferByDay = {};
            const durationByDay = {};
            
            // Process each session
            let filteredSessions = sessions.filter(session => {
                if (!session.created_at) return false;
                
                // Ensure proper date parsing
                const sessionDate = new Date(session.created_at);
                if (isNaN(sessionDate.getTime())) {
                    console.log(`Invalid date found: ${session.created_at}`);
                    return false;
                }
                
                const isInRange = sessionDate >= startDate && sessionDate <= now;
                return isInRange;
            });
            
            console.log(`Filtered ${filteredSessions.length} sessions in the ${days}-day range`);
            
            // If we have sessions in the period, process them
            if (filteredSessions.length > 0 || days > 0) { // Always show chart for valid day ranges
                // Create an array of all dates in the specified range
                const dateArray = [];
                for (let i = 0; i < days; i++) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    const dateKey = date.toISOString().split('T')[0];
                    dateArray.push(dateKey);
                }
                
                // Sort dates chronologically (oldest first)
                dateArray.sort();
                
                // Initialize all dates in the range with zero values
                dateArray.forEach(date => {
                    sessionsByDay[date] = 0;
                    earningsByDay[date] = 0;
                    dataTransferByDay[date] = 0;
                    durationByDay[date] = 0;
                });
                
                // Group by date
                filteredSessions.forEach(session => {
                    const sessionDate = new Date(session.created_at);
                    const date = sessionDate.toISOString().split('T')[0];
                    
                    // Make sure this date exists in our maps (it should since we initialized all dates)
                    if (date in sessionsByDay) {
                        // Add to daily counters
                        sessionsByDay[date] = (sessionsByDay[date] || 0) + 1;
                        earningsByDay[date] = (earningsByDay[date] || 0) + parseFloat(session.tokens || 0) / (10**18);
                        
                        // Use larger data values for more clarity in charts
                        const bytesTransferred = parseInt(session.bytes_sent || 0) + parseInt(session.bytes_received || 0);
                        dataTransferByDay[date] += bytesTransferred;
                        
                        // Make sure duration is properly counted
                        const duration = parseInt(session.duration || 0);
                        durationByDay[date] += duration;
                    }
                });
                
                // Use the dateArray for chart labels to ensure correct order
                const chartLabels = dateArray.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString();
                });
                
                // Prepare chart data in the same order as the labels
                const sessionsData = dateArray.map(date => sessionsByDay[date]);
                const earningsData = dateArray.map(date => earningsByDay[date].toFixed(4));
                const dataTransferData = dateArray.map(date => dataTransferByDay[date] / (1024 * 1024)); // Convert to MB
                const durationData = dateArray.map(date => durationByDay[date] / 3600); // Convert to hours
                
                // Debug the data for Data Transfer and Duration
                console.log("Data Transfer chart data:", dataTransferData);
                console.log("Duration chart data:", durationData);
                
                // Hide loading, show charts
                document.getElementById('chartLoading').style.display = 'none';
                document.getElementById('chartContainer').style.display = 'flex';
                
                // Clear existing charts before creating new ones to prevent memory leaks
                destroyExistingCharts();
                
                // Create the charts
                createChart('sessionsChart', 'Sessions', chartLabels, sessionsData);
                createChart('earningsChart', 'MYST Earned', chartLabels, earningsData);
                createChart('dataTransferChart', 'Data Transfer (MB)', chartLabels, dataTransferData);
                createChart('durationChart', 'Duration (hours)', chartLabels, durationData);
            } else {
                // No data available for the period
                document.getElementById('chartLoading').style.display = 'none';
                document.getElementById('noDataMessage').style.display = 'block';
            }
        } else {
            // No session data at all
            document.getElementById('chartLoading').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'block';
        }
    }
    
    // Store chart instances to destroy them before creating new ones
    let chartInstances = {};
    
    // Helper function to create a chart
    function createChart(canvasId, label, labels, data) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        chartInstances[canvasId] = new Chart(ctx, {
            type: 'line', // Changed from 'bar' to 'line'
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)', // Lighter background for line area
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2, // Slightly thicker lines for better visibility
                    tension: 0.2, // Add slight curve to the lines
                    fill: true, // Fill area under the line
                    pointRadius: 3, // Add visible points on the line
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0 // Use integer precision for session counts
                        }
                    },
                    x: {
                        grid: {
                            display: false // Less cluttered x-axis
                        }
                    }
                },
                interaction: {
                    intersect: false, // Hover anywhere on the vertical line
                    mode: 'index' // Show all datasets on hover
                }
            }
        });
    }
    
    // Function to destroy existing charts to prevent memory leaks
    function destroyExistingCharts() {
        for (const chartId in chartInstances) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
            }
        }
        chartInstances = {};
    }
    
    // Function to load node data
    function loadNodeData() {
        console.log(`Loading data for node ID: ${nodeId}`);
        
        // Show loading state in all sections
        const elements = ['healthInfo', 'sessionStats', 'identitiesList', 'servicesList', 'nodeQualityStats'];
        elements.forEach(id => {
            document.getElementById(id).innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Loading data...</span>
                </div>
            `;
        });
        
        // Make the API request to fetch node data
        fetch(`/node/${nodeId}/data`)
            .then(response => {
                console.log(`Received response with status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`Network response error: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Node data received:", data);
                
                // Store data globally for other functions to access
                window.nodeData = data;
                
                // Check if we got an error response from the server
                if (data.error) {
                    throw new Error(`API Error: ${data.error}`);
                }
                
                // Update all UI components with the received data
                updateHealthInfo(data.health, data.nat_info);
                updateSessionStats(data.stats, data.stats_daily, data.sessions);
                updateActiveSessionsStats(data.sessions);
                updateIdentitiesList(data.identities);
                updateServicesList(data.services, data);
                updateNodeQualityStats(data);
            })
            .catch(error => {
                console.error('Error loading node data:', error);
                showDetailedError(error.message);
            });
    }

    // Format bytes to human readable format
    function formatBytes(bytes, decimals = 2) {
        // Handle invalid values
        if (bytes === undefined || bytes === null || isNaN(bytes) || bytes === 0) {
            return '0 Bytes';
        }
        
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        if (i < 0 || i >= sizes.length) return bytes + ' Bytes';
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Format duration in seconds to human readable format
    function formatDuration(seconds) {
        // Handle invalid values
        if (seconds === undefined || seconds === null || isNaN(seconds)) {
            return '0h 0m 0s';
        }
        
        const secs = Math.floor(seconds % 60);
        const minutes = Math.floor((seconds % 3600) / 60);
        const hours = Math.floor(seconds / 3600);
        
        return `${hours}h ${minutes}m ${secs}s`;
    }

    // New function to show detailed error messages to the user
    function showDetailedError(errorDetails = '') {
        const elements = ['healthInfo', 'sessionStats', 'identitiesList', 'servicesList', 'nodeQualityStats'];
        elements.forEach(id => {
            document.getElementById(id).innerHTML = `
                <div class="alert alert-danger">
                    <h6>Connection Error</h6>
                    <p>Failed to load data from node. Check browser console for details.</p>
                    ${errorDetails ? `<p><strong>Error details:</strong> ${errorDetails}</p>` : ''}
                    <button class="btn btn-sm btn-primary mt-2" onclick="loadNodeData()">
                        <i class="fas fa-sync-alt"></i> Retry
                    </button>
                </div>
            `;
        });
    }

    // New function to fetch real-time connection statistics - updated to use the dedicated endpoint
    function fetchConnectionStats() {
        // Get active sessions from the dedicated endpoint that doesn't hit quality API
        fetch(`/node/${nodeId}/active_sessions`)
            .then(response => response.json())
            .then(data => {
                if (data.sessions && data.sessions.items) {
                    // Filter active sessions: status = "New" AND not older than 14 days
                    const activeSessions = data.sessions.items.filter(session => {
                        if (session.status !== 'New') return false;
                        
                        // Filter out sessions older than 14 days (2 weeks)
                        const sessionDate = new Date(session.created_at);
                        const now = new Date();
                        const twoWeeksAgo = new Date(now.getTime() - (14 * 24 * 60 * 60 * 1000));
                        
                        return sessionDate >= twoWeeksAgo;
                    });
                    
                    if (activeSessions.length > 0) {
                        // Pass empty connection stats since that endpoint doesn't work for provider mode
                        displayActiveSessionsWithRealTimeData(activeSessions, {});
                    } else {
                        // No active sessions
                        const activeSessionsDiv = document.getElementById('activeSessionsStats');
                        activeSessionsDiv.innerHTML = `
                            <div class="text-center py-3">
                                <i class="fas fa-plug fa-3x text-muted mb-3"></i>
                                <p class="mb-0">No active sessions at the moment</p>
                            </div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error("Error fetching sessions:", error);
                const activeSessionsDiv = document.getElementById('activeSessionsStats');
                activeSessionsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <p>Error fetching session data: ${error.message}</p>
                        <button class="btn btn-sm btn-primary mt-2" onclick="fetchConnectionStats()">
                            <i class="fas fa-sync-alt"></i> Retry
                        </button>
                    </div>
                `;
            });
    }

    // Update active sessions statistics
    function updateActiveSessionsStats(sessions) {
        const activeSessionsDiv = document.getElementById('activeSessionsStats');
        const activeSessionsCard = document.getElementById('activeSessionsCard');
        const activeSessionsCount = document.getElementById('activeSessionsCount');
        
        let html = '';
        
        // Filter active sessions: status = "New" AND not older than 14 days
        const activeSessions = sessions && sessions.items ? 
            sessions.items.filter(session => {
                if (session.status !== 'New') return false;
                
                // Filter out sessions older than 14 days (2 weeks)
                const sessionDate = new Date(session.created_at);
                const now = new Date();
                const twoWeeksAgo = new Date(now.getTime() - (14 * 24 * 60 * 60 * 1000));
                
                return sessionDate >= twoWeeksAgo;
            }) : [];
        
        console.log(`Found ${activeSessions.length} active sessions with status "New" created within the last 14 days`);
        
        // Update active sessions count
        activeSessionsCount.textContent = activeSessions.length;
        
        // Show/hide card based on whether there are active sessions
        if (activeSessions.length === 0) {
            html = '<div class="text-center py-3">';
            html += '<i class="fas fa-plug fa-3x text-muted mb-3"></i>';
            html += '<p class="mb-0">No active sessions at the moment</p>';
            html += '</div>';
            activeSessionsDiv.innerHTML = html;
        } else {
            // Show loading indicator while we prepare the data
            html = `
                <div class="d-flex justify-content-center mb-3">
                    <div class="spinner-border spinner-border-sm text-warning me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Preparing session data...</span>
                </div>
            `;
            activeSessionsDiv.innerHTML = html;
            
            // Directly display the active sessions we already have
            displayActiveSessionsWithRealTimeData(activeSessions, {});
        }
    }

    // Function to display active sessions with real-time data
    function displayActiveSessionsWithRealTimeData(activeSessions, connStats) {
        const activeSessionsDiv = document.getElementById('activeSessionsStats');
        let html = '';
        
        // Create object to store session data including estimated data transfer
        const sessionData = {};
        
        // Initialize estimated data for each session
        activeSessions.forEach(session => {
            const sessionId = session.id;
            const startTime = session.created_at ? new Date(session.created_at) : new Date();
            const now = new Date();
            const durationSeconds = Math.floor((now - startTime) / 1000);
            
            // Calculate how old the session is
            const hoursOld = Math.floor((now - startTime) / (60 * 60 * 1000));
            const daysOld = Math.floor(hoursOld / 24);
            
            // Initialize with data from the sessions endpoint
            sessionData[sessionId] = {
                id: sessionId,
                startTime: startTime,
                durationSeconds: durationSeconds,
                hoursOld: hoursOld,
                daysOld: daysOld,
                consumerCountry: session.consumer_country || 'Unknown'
            };
        });
        
        // Show the active sessions header with a clear message about API limitations
        html += `
            <div class="alert alert-warning">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>${activeSessions.length} Active Sessions</strong>
                    <span class="badge bg-danger blink">LIVE</span>
                </div>

                <div class="small mb-2 text-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Real-time data transfer is not available from the Nodes API it is a limitation of the Mysterium nodes API.
                </div>
                <div class="small mb-2 text-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Some sessions may be stale if you have rebooted your node. This is a known issue with the Mysterium node software not cleaning up sessions properly.
                </div>
            </div>
        `;

        // Create a table for active sessions
        html += '<div class="table-responsive">';
        html += '<table class="table table-hover table-sm" id="active-sessions-table">';
        html += '<thead><tr><th>ID</th><th>Started</th><th>Age</th><th>Duration</th><th>Consumer</th></tr></thead>';
        html += '<tbody>';
        
        // Sort active sessions by age (newest first)
        const sortedActiveSessions = [...activeSessions].sort((a, b) => {
            const dateA = new Date(a.created_at || 0);
            const dateB = new Date(b.created_at || 0);
            return dateB - dateA; // Newest first
        });
        
        sortedActiveSessions.forEach(session => {
            const sessionId = session.id;
            const displayId = sessionId ? sessionId.substring(0, 8) + '...' : 'Unknown';
            const startTime = sessionData[sessionId].startTime;
            const durationSeconds = sessionData[sessionId].durationSeconds;
            const duration = formatDuration(durationSeconds);
            const hoursOld = sessionData[sessionId].hoursOld;
            const daysOld = sessionData[sessionId].daysOld;
            const consumerCountry = sessionData[sessionId].consumerCountry;
            
            // Format age display - show days if > 24 hours old
            const ageDisplay = daysOld > 0 ? 
                `${daysOld}d ${hoursOld % 24}h old` : 
                `${hoursOld}h old`;
            
            // Add warning classes based on age
            let rowClass = '';
            if (daysOld >= 3) {
                rowClass = 'table-danger'; // Red for very old sessions (3+ days)
            } else if (daysOld >= 1) {
                rowClass = 'table-warning'; // Yellow for older sessions (1-3 days)
            }
            
            html += `
                <tr data-session-id="${sessionId}" class="${rowClass}">
                    <td>${displayId}</td>
                    <td>${startTime.toLocaleString()}</td>
                    <td>${ageDisplay}</td>
                    <td class="session-duration">${duration}</td>
                    <td>${consumerCountry}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        
        // Add refresh controls
        html += `
            <div class="text-center mt-3">
                <div class="text-muted small mb-2">
                    Live session data refreshes automatically every 5 seconds
                </div>
                <button id="manualRefreshStats" class="btn btn-sm btn-outline-warning">
                    <i class="fas fa-sync-alt me-1"></i> Refresh Now
                </button>
            </div>
        `;
        
        // Add custom CSS for the blinking live indicator
        html += `
            <style>
                .blink {
                    animation: blinker 1.5s linear infinite;
                }
                @keyframes blinker {
                    50% { opacity: 0.5; }
                }
            </style>
        `;
        
        activeSessionsDiv.innerHTML = html;
        
        // Set up regular updates for session durations
        updateSessionDurations(sessionData);
        
        // Add event listener for manual refresh button
        document.getElementById('manualRefreshStats').addEventListener('click', fetchConnectionStats);
    }

    // Simplified function to update all session durations regularly
    function updateSessionDurations(sessionData) {
        // Create an interval that runs every second
        const intervalId = setInterval(() => {
            const now = new Date();
            
            // Update each row's duration
            for (const sessionId in sessionData) {
                const session = sessionData[sessionId];
                const startTime = session.startTime;
                const durationSeconds = Math.floor((now - startTime) / 1000);
                
                // Update sessionData object
                session.durationSeconds = durationSeconds;
                
                // Update row if it exists in the DOM
                const durationCell = document.querySelector(`#active-sessions-table tr[data-session-id="${sessionId}"] .session-duration`);
                if (durationCell) {
                    durationCell.textContent = formatDuration(durationSeconds);
                } else {
                    // If the row no longer exists, this session might have ended
                    // In this case, we should consider removing it from tracking
                    console.log(`Session ${sessionId} duration cell not found in DOM, session may have ended`);
                }
            }
            
            // Get active sessions count element to check if we should stop updating
            const activeSessionsCount = document.getElementById('activeSessionsCount');
            if (!activeSessionsCount || parseInt(activeSessionsCount.textContent) === 0) {
                // No active sessions anymore, clear the interval to save resources
                clearInterval(intervalId);
                console.log("Cleared duration update interval: no active sessions");
            }
        }, 1000); // Update every second
        
        // Return the interval ID in case we need to clear it elsewhere
        return intervalId;
    }

    // Update health information to include NAT type and monitoring status
    function updateHealthInfo(health, natInfo) {
        const healthInfoDiv = document.getElementById('healthInfo');
        
        // Debug NAT info 
        console.log("NAT info received:", natInfo);
        
        let html = '<h6>Health Status</h6>';
        if (health) {
            html += `
                <p><strong>Version:</strong> ${health.version}</p>
                <p><strong>Uptime:</strong> ${health.uptime}</p>
                <p><strong>Process:</strong> ${health.process}</p>
            `;

            // Add NAT type information
            if (natInfo && typeof natInfo === 'object') {
                console.log("Adding NAT info to display:", natInfo);
                
                // Extract NAT properties, with defaults if missing
                const natType = (natInfo.type || 'unknown').toLowerCase();
                
                // Display with color indicators based on status
                let natTypeClass, natTypeExplanation;
                
                switch(natType) {
                    case 'symmetric':
                        natTypeClass = 'text-warning';
                        natTypeExplanation = 'Limited connectivity - may cause issues with some services';
                        break;
                    case 'fullcone':
                        natTypeClass = 'text-success';
                        natTypeExplanation = 'Good - full cone NAT allows incoming connections from any source';
                        break;
                    case 'none':
                        natTypeClass = 'text-success';
                        natTypeExplanation = 'Excellent - direct internet connection without NAT';
                        break;
                    case 'unknown':
                        natTypeClass = 'text-muted';
                        natTypeExplanation = 'Unable to determine NAT type';
                        break;
                    default:
                        natTypeClass = 'text-info';
                        natTypeExplanation = 'Standard NAT configuration';
                }
                
                html += `
                    <p>
                        <strong>NAT Type:</strong> 
                        <span class="${natTypeClass}">${natType.toUpperCase()}</span>
                        <i class="fas fa-info-circle ms-1" data-bs-toggle="tooltip" title="${natTypeExplanation}"></i>
                    </p>
                `;
            } else {
                console.warn("NAT info is missing or not an object:", natInfo);
                html += `<p><strong>NAT Info:</strong> <span class="text-muted">Not available from node</span></p>`;
            }
            
            // Add monitoring status if available
            if (window.nodeData && window.nodeData.monitoring_status) {
                const monitoringStatus = window.nodeData.monitoring_status;
                console.log("Monitoring status:", monitoringStatus);
                
                const status = monitoringStatus.status || 'unknown';
                
                // Display with color indicators based on status
                let statusClass, statusExplanation;
                
                switch(status.toLowerCase()) {
                    case 'online':
                    case 'success': // Add support for "success" status
                        statusClass = 'text-success';
                        statusExplanation = 'Node is being monitored and is online';
                        break;
                    case 'offline':
                        statusClass = 'text-danger';
                        statusExplanation = 'Node is being monitored but is offline';
                        break;
                    case 'unknown':
                        statusClass = 'text-muted';
                        statusExplanation = 'Node monitoring status is unknown';
                        break;
                    default:
                        statusClass = 'text-info';
                        statusExplanation = 'Status from node monitoring service';
                }
                
                html += `
                    <p>
                        <strong>Monitoring Status:</strong> 
                        <span class="${statusClass}">${status.toUpperCase()}</span>
                        <i class="fas fa-info-circle ms-1" data-bs-toggle="tooltip" title="${statusExplanation}"></i>
                    </p>
                `;
            }
            
            html += `<p><strong>Status:</strong> <span class="badge bg-success">Online</span></p>`;
        } else {
            html += '<p>No health information available</p>';
        }
        
        healthInfoDiv.innerHTML = html;
        
        // Re-initialize tooltips for the new content
        try {
            if (typeof bootstrap !== 'undefined') {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        } catch (e) {
            console.error("Error initializing tooltips:", e);
        }
    }

    // Update session statistics
    function updateSessionStats(stats, statsDaily, sessions) {
        const statsDiv = document.getElementById('sessionStats');
        
        let html = '';
        if (stats && stats.stats) {
            // Get the values from the aggregated stats with correct snake_case property names
            const sumTokens = stats.stats.sum_tokens || 0;
            const count = stats.stats.count || 0;
            const sumBytesSent = stats.stats.sum_bytes_sent || 0;
            const sumBytesReceived = stats.stats.sum_bytes_received || 0;
            const sumDuration = stats.stats.sum_duration || 0;
            
            // Calculate total earnings safely
            const totalEarnings = (sumTokens / (10**18)).toFixed(4);
            
            // Calculate statistics from the actual sessions shown (last 50)
            let visibleSessionsStats = {
                count: 0,
                sumTokens: 0,
                sumBytesSent: 0,
                sumBytesReceived: 0,
                sumDuration: 0
            };
            
            if (sessions && sessions.items && sessions.items.length > 0) {
                visibleSessionsStats.count = sessions.items.length;
                
                sessions.items.forEach(session => {
                    visibleSessionsStats.sumTokens += parseFloat(session.tokens || 0);
                    visibleSessionsStats.sumBytesSent += parseInt(session.bytes_sent || 0);
                    visibleSessionsStats.sumBytesReceived += parseInt(session.bytes_received || 0);
                    visibleSessionsStats.sumDuration += parseInt(session.duration || 0);
                });
            }
            
            const visibleEarnings = (visibleSessionsStats.sumTokens / (10**18)).toFixed(4);
            
            // Calculate Today's stats
            let todayStats = {
                count: 0,
                tokens: 0,
                bytes_sent: 0,
                bytes_received: 0,
                duration: 0
            };
            
            // Get today's date at midnight for comparison
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Filter sessions for today only
            let todaySessions = [];
            if (sessions && sessions.items && sessions.items.length > 0) {
                todaySessions = sessions.items.filter(session => {
                    if (!session.created_at) return false;
                    const sessionDate = new Date(session.created_at);
                    return sessionDate >= today;
                });
                
                todayStats.count = todaySessions.length;
                
                // Calculate today's stats
                todaySessions.forEach(session => {
                    todayStats.tokens += parseFloat(session.tokens || 0);
                    todayStats.bytes_sent += parseInt(session.bytes_sent || 0);
                    todayStats.bytes_received += parseInt(session.bytes_received || 0);
                    todayStats.duration += parseInt(session.duration || 0);
                });
            }
            
            const todayEarnings = (todayStats.tokens / (10**18)).toFixed(4);
            const todayDataTransfer = formatBytes(todayStats.bytes_sent + todayStats.bytes_received);
            
            // Create tabs for All-time and Today's stats
            html += `
                <ul class="nav nav-tabs mb-3" id="statsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-time-tab" data-bs-toggle="tab" data-bs-target="#all-time" type="button" role="tab">All-time Stats</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="today-tab" data-bs-toggle="tab" data-bs-target="#today" type="button" role="tab">Today's Stats</button>
                    </li>
                </ul>
                <div class="tab-content" id="statsTabContent">
                    <div class="tab-pane fade show active" id="all-time" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Total Node Statistics</h6>
                                <p><strong>Total Sessions:</strong> ${count}</p>
                                <p><strong>Total Earnings:</strong> ${totalEarnings} MYST</p>
                                <p><strong>Total Bytes Sent:</strong> ${formatBytes(sumBytesSent)}</p>
                                <p><strong>Total Bytes Received:</strong> ${formatBytes(sumBytesReceived)}</p>
                                <p><strong>Total Duration:</strong> ${formatDuration(sumDuration)}</p>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Visible Sessions Statistics (Last 50)</h6>
                                <p><strong>Sessions:</strong> ${visibleSessionsStats.count}</p>
                                <p><strong>Earnings:</strong> ${visibleEarnings} MYST</p>
                                <p><strong>Bytes Sent:</strong> ${formatBytes(visibleSessionsStats.sumBytesSent)}</p>
                                <p><strong>Bytes Received:</strong> ${formatBytes(visibleSessionsStats.sumBytesReceived)}</p>
                                <p><strong>Duration:</strong> ${formatDuration(visibleSessionsStats.sumDuration)}</p>
                            </div>
                        </div>
                        ${sessions && sessions.items && sessions.items.length > 0 ? `
                            <div class="mt-4">
                                <a class="btn btn-outline-secondary btn-sm w-100" data-bs-toggle="collapse" href="#allSessionsCollapse" role="button" aria-expanded="false" aria-controls="allSessionsCollapse">
                                    Show/Hide All Sessions (${sessions.items.length})
                                </a>
                                <small class="text-muted d-block text-center mt-1">Note: Only the most recent 50 sessions are shown</small>
                                <div class="collapse mt-3" id="allSessionsCollapse">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead><tr><th>ID</th><th>Created</th><th>Duration</th><th>Data Transferred</th><th>Earnings</th><th>Status</th></tr></thead>
                                            <tbody>
                                                ${sessions.items.map(session => {
                                                    const sessionId = session.id ? session.id.substring(0, 8) + '...' : 'Unknown';
                                                    const createdAt = session.created_at ? new Date(session.created_at).toLocaleString() : 'Unknown';
                                                    const duration = formatDuration(session.duration || 0);
                                                    const bytesTransferred = (session.bytes_received || 0) + (session.bytes_sent || 0);
                                                    const sessionTokens = ((session.tokens || 0) / (10**18)).toFixed(4);
                                                    return `
                                                        <tr class="${session.status === 'New' ? 'table-warning' : ''}">
                                                            <td>${sessionId}</td>
                                                            <td>${createdAt}</td>
                                                            <td>${duration}</td>
                                                            <td>${formatBytes(bytesTransferred)}</td>
                                                            <td>${sessionTokens} MYST</td>
                                                            <td><span class="badge bg-${session.status === 'Completed' ? 'success' : 'warning'}">${session.status}</span></td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>    
                                        </table>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="tab-pane fade" id="today" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">Today's Statistics (${new Date().toLocaleDateString()})</h6>
                            </div>
                            <div class="card-body">
                                ${todayStats.count > 0 ? `
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card mb-3">
                                                <div class="card-body text-center">
                                                    <h3 class="card-title">${todayStats.count}</h3>
                                                    <p class="card-text text-muted">Sessions Today</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card mb-3">
                                                <div class="card-body text-center">
                                                    <h3 class="card-title">${todayEarnings}</h3>
                                                    <p class="card-text text-muted">MYST Earned Today</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card mb-3">
                                                <div class="card-body text-center">
                                                    <h3 class="card-title">${todayDataTransfer}</h3>
                                                    <p class="card-text text-muted">Data Transferred Today</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card mb-3">
                                                <div class="card-body text-center">
                                                    <h3 class="card-title">${formatDuration(todayStats.duration)}</h3>
                                                    <p class="card-text text-muted">Connection Time Today</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <h6 class="mb-3">Today's Sessions</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Time</th>
                                                    <th>Duration</th>
                                                    <th>Data</th>
                                                    <th>Earnings</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${todaySessions.map(session => {
                                                    const sessionId = session.id ? session.id.substring(0, 8) + '...' : 'Unknown';
                                                    const createdAt = session.created_at ? new Date(session.created_at).toLocaleTimeString() : 'Unknown';
                                                    const duration = formatDuration(session.duration || 0);
                                                    const bytesTransferred = (session.bytes_received || 0) + (session.bytes_sent || 0);
                                                    const sessionTokens = ((session.tokens || 0) / (10**18)).toFixed(4);
                                                    return `
                                                        <tr class="${session.status === 'New' ? 'table-warning' : ''}">
                                                            <td>${sessionId}</td>
                                                            <td>${createdAt}</td>
                                                            <td>${duration}</td>
                                                            <td>${formatBytes(bytesTransferred)}</td>
                                                            <td>${sessionTokens} MYST</td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : `
                                    <div class="text-center py-5">
                                        <i class="fas fa-calendar-day fa-4x text-muted mb-3"></i>
                                        <h5>No Sessions Today</h5>
                                        <p class="text-muted">There haven't been any sessions recorded today.</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            html += '<p>No session statistics available</p>';
        }
        
        statsDiv.innerHTML = html;
    }

    // Update identities list
    function updateIdentitiesList(identities) {
        const identitiesDiv = document.getElementById('identitiesList');
        
        console.log("Identities data received:", identities);
        
        let html = '<h6 class="mb-3">Identities</h6>';
        
        // Check if identities exists and has the proper structure
        if (identities && identities.identities && identities.identities.length > 0) {
            html += '<div class="list-group">';
            
            identities.identities.forEach(identity => {
                // Get registration status only if it's actually available and meaningful
                const regStatus = identity.registration_status || '';
                let statusBadge = '';
                
                if (regStatus && regStatus !== 'Unknown') {
                    const statusClass = regStatus === 'Registered' ? 'success' : 
                                       (regStatus === 'InProgress' ? 'warning' : 'secondary');
                    statusBadge = `<span class="badge bg-${statusClass}">${regStatus}</span>`;
                }
                
                // Format identity display
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong class="text-primary">Identity</strong>
                            ${statusBadge}
                        </div>
                        <div class="mb-2 d-flex align-items-center">
                            <span class="text-break text-monospace">${identity.id}</span>
                            <button class="btn btn-sm btn-outline-secondary ms-2" 
                                    onclick="navigator.clipboard.writeText('${identity.id}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="small text-muted">
                            ${identity.channel_address ? 
                                `<span class="me-3"><i class="fas fa-tag me-1"></i> ${identity.channel_address}</span>` : ''}
                            <span><i class="fas fa-clock me-1"></i> ${new Date(identity.created_at || Date.now()).toLocaleString()}</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        } else {
            html += '<div class="alert alert-info">';
            html += '<p class="mb-0"><i class="fas fa-info-circle me-2"></i> No identities found</p>';
            html += '<small>Your node must have at least one identity to operate. Check your node setup.</small>';
            html += '</div>';
        }
        
        identitiesDiv.innerHTML = html;
    }
    
    // Update node quality stats
    function updateNodeQualityStats(data) {
        const nodeQualityStatsDiv = document.getElementById('nodeQualityStats');
        let html = '<h6 class="mb-3">Node Quality Statistics</h6>';
        
        // Check if we have quality metrics from the discovery API
        if (data && data.quality_metrics) {
            const quality = data.quality_metrics;
            
            // Create a rating display with colored indicator
            let qualityRating = 'Unknown';
            let qualityClass = 'text-muted';
            
            if (quality.quality !== undefined) {
                // Define rating based on quality score (scale 0-3)
                if (quality.quality >= 2.5) {
                    qualityRating = 'Excellent';
                    qualityClass = 'text-success';
                } else if (quality.quality >= 2.0) {
                    qualityRating = 'Good';
                    qualityClass = 'text-info';
                } else if (quality.quality >= 1.5) {
                    qualityRating = 'Average';
                    qualityClass = 'text-primary';
                } else if (quality.quality >= 1.0) {
                    qualityRating = 'Poor';
                    qualityClass = 'text-warning';
                } else {
                    qualityRating = 'Very Poor';
                    qualityClass = 'text-danger';
                }
            }
            
            // Display quality score with rating
            html += `
                <div class="mb-3">
                    <p class="mb-1"><strong>Quality Score:</strong> <span class="${qualityClass}">${quality.quality?.toFixed(1) || 'N/A'}/3.0 (${qualityRating})</span></p>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-${qualityClass.replace('text-', '')}" 
                             role="progressbar" 
                             style="width: ${((quality.quality || 0) / 3) * 100}%"
                             aria-valuenow="${quality.quality || 0}" 
                             aria-valuemin="0" 
                             aria-valuemax="3">
                        </div>
                    </div>
                </div>
            `;
            
            // Create a list of detailed metrics with appropriate units
            html += `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Uptime:</strong> ${quality.uptime || 0} hrs</p>
                        <p><strong>Latency:</strong> ${quality.latency?.toFixed(1) || 'N/A'} ms</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Bandwidth:</strong> ${quality.bandwidth?.toFixed(1) || 'N/A'} Mbps</p>
                        <p><strong>Packet Loss:</strong> ${quality.packetLoss !== undefined ? quality.packetLoss + '%' : 'N/A'}</p>
                    </div>
                </div>
            `;
            
            // Add location and IP information section
            html += `<hr class="my-3">`;
            
            // Add location information if available
            const location = data.location_info || {};
            const ipInfo = data.ip_info || {};
            
            html += `
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="fas fa-map-marker-alt me-2 text-danger"></i>
                            Node Location & Network Information
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Country:</strong> ${location.country || 'Unknown'}</p>
                                <p><strong>City:</strong> ${location.city || 'Unknown'}</p>
                                <p><strong>ISP:</strong> ${location.isp || 'Unknown'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>IP Type:</strong> ${data.nat_info?.type ? data.nat_info.type.toUpperCase() : 'Unknown'}</p>
                                <p><strong>Continent:</strong> ${location.continent || 'Unknown'}</p>
                            </div>
                        </div>
                        
                        <!-- Optional: Add a map link if we have coordinates -->
                        ${(location.latitude && location.longitude) ? `
                            <div class="text-center mt-2">
                                <a href="https://www.google.com/maps?q=${location.latitude},${location.longitude}" 
                                   target="_blank" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-map me-1"></i> View on Map
                                </a>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        } else {
            // No quality metrics available
            html += `
                <div class="alert alert-info">
                    <p class="mb-0"><i class="fas fa-info-circle me-2"></i> No quality metrics available for this node.</p>
                    <small>Metrics become available after the node has been running for some time.</small>
                </div>
            `;
        }
        
        nodeQualityStatsDiv.innerHTML = html;
    }
    
    // Update services list
    function updateServicesList(services, data) {
        const servicesDiv = document.getElementById('servicesList');
        
        // Define all possible service types in Mysterium
        const serviceTypes = ['data_transfer', 'wireguard', 'dvpn', 'scraping', 'quic_scraping'];
        
        // Create friendly names mapping for display
        const serviceTypeNames = {
            'data_transfer': 'B2B VPN/Data Transfer',
            'wireguard': 'Public',
            'dvpn': 'VPN',
            'scraping': 'B2B Scraping',
            'quic_scraping': 'QUIC Scraping'
        };
        
        // Get friendly name for display
        const getFriendlyName = (type) => {
            return serviceTypeNames[type] || type;
        };
        
        // Store the provider ID from identities for use with services
        let providerId = null;
        if (data && data.identities && data.identities.identities && data.identities.identities.length > 0) {
            providerId = data.identities.identities[0].id;
            console.log("Using provider ID from identity:", providerId);
        }
        
        // Debug - log current services from API
        console.log("Current running services from API:", services);
        console.log("Current known services in UI:", knownServices);
        
        // Initialize trackable service map
        let serviceMap = {};
        
        // First, create a map of all possible service types
        serviceTypes.forEach(type => {
            // Default state for service
            serviceMap[type] = {
                id: null,
                type: type,
                status: 'NotPresent',
                providerId: providerId
            };
        });
        
        // Add running services from API to the map
        if (services && services.length > 0) {
            services.forEach(service => {
                serviceMap[service.type] = {
                    ...service,
                    status: 'Running',
                    providerId: providerId || service.providerId
                };
            });
        }
        
        // Add any stopped services from previous state that aren't running
        knownServices.forEach(service => {
            if (service.status === 'Stopped' && 
                (!serviceMap[service.type] || serviceMap[service.type].status !== 'Running')) {
                serviceMap[service.type] = {
                    ...service,
                    providerId: providerId || service.providerId
                };
            }
        });
        
        // Convert map back to array for display
        let updatedServices = Object.values(serviceMap).filter(
            // Only include services that are Running or Stopped
            service => service.status === 'Running' || service.status === 'Stopped'
        );
        
        // Update known services state
        knownServices = updatedServices;
        
        // Save to localStorage
        localStorage.setItem(`node_${nodeId}_services`, JSON.stringify(knownServices));
        
        // Render the services UI
        let html = '<h6 class="mb-3">Active Services</h6>';
        
        if (knownServices.length > 0) {
            html += `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 35%">Service Type</th>
                                <th style="width: 35%">ID</th>
                                <th style="width: 15%">Status</th>
                                <th style="width: 15%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Sort services by type according to predefined order
            const sortedServices = [...knownServices].sort((a, b) => {
                const typeIndexA = serviceTypes.indexOf(a.type);
                const typeIndexB = serviceTypes.indexOf(b.type);
                return typeIndexA - typeIndexB;
            });
            
            sortedServices.forEach(service => {
                const isRunning = service.status === 'Running';
                const serviceId = service.id || '';
                // Display a shortened version of the ID if it's too long
                const displayId = serviceId.length > 20 ? 
                    serviceId.substring(0, 10) + '...' + serviceId.substring(serviceId.length - 8) : 
                    serviceId;
                
                html += `
                    <tr>
                        <td>${getFriendlyName(service.type)}</td>
                        <td class="text-nowrap text-muted"><small>${displayId}</small></td>
                        <td><span class="badge bg-${isRunning ? 'success' : 'warning'}">${service.status}</span></td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-success me-1 service-start-btn" 
                                    data-provider-id="${service.providerId}" 
                                    data-service-type="${service.type}" 
                                    title="Start service"
                                    ${isRunning ? 'disabled' : ''}>
                                    <i class="fas fa-play"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger service-stop-btn" 
                                    data-service-id="${service.id}" 
                                    title="Stop service"
                                    ${!isRunning ? 'disabled' : ''}>
                                    <i class="fas fa-stop"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            // Add buttons for missing service types
            const missingTypes = serviceTypes.filter(type => 
                !knownServices.some(service => service.type === type)
            );
            
            if (missingTypes.length > 0 && providerId) {
                html += '<div class="mt-4">';
                html += '<h6>Start Additional Services:</h6>';
                html += '<div class="d-flex flex-wrap gap-2 justify-content-center">';
                
                missingTypes.forEach(type => {
                    html += `
                        <button type="button" class="btn btn-outline-success service-start-btn m-1"
                            data-provider-id="${providerId}" 
                            data-service-type="${type}">
                            <i class="fas fa-plus-circle me-1"></i> ${getFriendlyName(type)}
                        </button>
                    `;
                });
                
                html += '</div></div>';
            }
        } else {
            html += '<div class="alert alert-info">';
            html += '<p class="mb-0"><i class="fas fa-info-circle me-2"></i> No services running</p>';
            html += '</div>';
            
            // If we have identities, show buttons for all service types
            if (providerId) {
                html += '<div class="mt-4">';
                html += '<h6>Start Services:</h6>';
                html += '<div class="d-flex flex-wrap gap-2 justify-content-center">';
                
                serviceTypes.forEach(type => {
                    html += `
                        <button type="button" class="btn btn-outline-success service-start-btn m-1"
                            data-provider-id="${providerId}" 
                            data-service-type="${type}">
                            <i class="fas fa-plus-circle me-1"></i> ${getFriendlyName(type)}
                        </button>
                    `;
                });
                
                html += '</div></div>';
            }
        }
        
        servicesDiv.innerHTML = html;
        
        // Attach event listeners to service buttons
        document.querySelectorAll('.service-start-btn').forEach(button => {
            button.addEventListener('click', function() {
                const providerId = this.getAttribute('data-provider-id');
                const serviceType = this.getAttribute('data-service-type');
                startService(providerId, serviceType);
            });
        });
        
        document.querySelectorAll('.service-stop-btn').forEach(button => {
            button.addEventListener('click', function() {
                const serviceId = this.getAttribute('data-service-id');
                stopService(serviceId);
            });
        });
    }

    // Function to start a service
    function startService(providerId, serviceType) {
        fetch(`/node/${nodeId}/services`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ provider_id: providerId, service_type: serviceType })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Service started:', data);
            loadNodeData();  // Reload data to reflect changes
        })
        .catch(error => {
            console.error('Error starting service:', error);
            alert(`Error starting service: ${error.message}`);
        });
    }

    // Function to stop a service
    function stopService(serviceId) {
        fetch(`/node/${nodeId}/services/${serviceId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Service stopped:', data);
            loadNodeData();  // Reload data to reflect changes
        })
        .catch(error => {
            console.error('Error stopping service:', error);
            alert(`Error stopping service: ${error.message}`);
        });
    }
</script>
{% endblock %}
